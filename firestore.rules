rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =============================
       HELPERS
    ============================= */
    function isAuthed() {
      return request.auth != null;
    }

    function isAdmin() {
      // NOTE: this mirrors your previous behavior (all authed users treated as admin).
      // Tighten if you later add a real admin flag/claim.
      return isAuthed();
    }

    /* =============================
       USER UPDATE VALIDATION
       (Expression-only, <= 10 vars)
    ============================= */
    function validUserUpdate() {
      let old   = resource.data;
      let newer = request.resource.data;

      let allowedKeys = [
        "username", "usernameLower", "usernameChangedAt",
        "email", "balance", "admin", "isBanned", "createdAt",
        "auditLog", "referralCode", "referredBy", "totalReferralEarnings",
        "referralPending", "shortcutBonusClaimed", "shortcutBonusToken",
        "dailyStreak", "bonusPercent", "lastCheckIn"
      ];

      let keysOk = newer.keys().hasOnly(allowedKeys) &&
                   allowedKeys.hasAll(old.keys());

      let immutableOk =
           newer.admin == old.admin &&
           newer.isBanned == old.isBanned &&
           newer.createdAt == old.createdAt &&
           newer.auditLog == old.auditLog &&
           newer.referralCode == old.referralCode &&
           newer.referredBy == old.referredBy &&
           newer.totalReferralEarnings == old.totalReferralEarnings &&
           newer.referralPending == old.referralPending;

      let usernameSame = newer.username == old.username;

      // Username cooldown, validity, and lowercase are bundled here
      let usernameCooldownOk =
        usernameSame ||
        (
          newer.username is string &&
          newer.username.matches("^[A-Za-z0-9._-]{3,20}$") &&
          newer.usernameLower == newer.username.lower() &&
          newer.usernameChangedAt is timestamp &&
          (
            !(old.usernameChangedAt is timestamp) ||
            request.time.toMillis() - old.usernameChangedAt.toMillis()
              >= 30 * 24 * 60 * 60 * 1000
          ) &&
          (
            !(old.usernameChangedAt is timestamp) ||
            newer.usernameChangedAt.toMillis() >= old.usernameChangedAt.toMillis()
          )
        );

      let balanceOk =
           newer.balance is number &&
           old.balance is number &&
           newer.balance >= 0 &&
           newer.balance <= old.balance;

      let shortcutOk =
           (newer.shortcutBonusClaimed == true ||
            newer.shortcutBonusClaimed == false) &&
           (newer.shortcutBonusToken is string ||
            newer.shortcutBonusToken == null);

      return keysOk &&
             immutableOk &&
             balanceOk &&
             shortcutOk &&
             (newer.username is string &&
              newer.username.matches("^[A-Za-z0-9._-]{3,20}$")) &&
             (newer.usernameLower == newer.username.lower()) &&
             usernameCooldownOk &&
             (usernameSame
               ? newer.usernameChangedAt == old.usernameChangedAt
               : true);
    }

    /* =============================
       USERS
    ============================= */
    match /users/{uid} {

      allow create: if isAuthed() &&
                    request.auth.uid == uid &&
                    request.resource.data.balance == 0 &&
                    request.resource.data.admin == false &&
                    request.resource.data.isBanned == false &&
                    request.resource.data.createdAt is timestamp &&
                    request.resource.data.referralCode is string &&
                    (
                      request.resource.data.referredBy is string ||
                      request.resource.data.referredBy == null
                    );

      allow read: if isAuthed() &&
                  (request.auth.uid == uid || isAdmin());

      allow update: if isAdmin() ||
                    request.auth == null ||
                    (
                      isAuthed() &&
                      request.auth.uid == uid &&
                      validUserUpdate()
                    );

      allow delete: if isAdmin() || request.auth == null;
    }

    /* =============================
       SUBCOLLECTIONS
    ============================= */
    match /users/{uid}/referrals/{r} {
      allow read: if isAuthed() &&
                  (request.auth.uid == uid || isAdmin());

      allow write: if request.auth == null || isAdmin();
    }

    match /users/{uid}/startedOffers/{offerId} {
      allow read: if isAuthed() &&
                  (request.auth.uid == uid || isAdmin());

      allow write: if (isAuthed() && request.auth.uid == uid) ||
                   request.auth == null ||
                   isAdmin();
    }

    match /users/{uid}/offers/{o} {
      allow read: if isAuthed() &&
                  (request.auth.uid == uid || isAdmin());
      allow write: if false;
    }

    match /users/{uid}/payouts/{p} {
      allow read: if isAuthed() &&
                  (request.auth.uid == uid || isAdmin());

      // Users can log their own payout requests (pending only)
      allow create: if isAuthed() &&
                    request.auth.uid == uid &&
                    request.resource.data.keys().hasOnly([
                      "type",
                      "method",
                      "amount",
                      "status",
                      "createdAt",
                      "notes",
                      "cryptoFee",
                      "refunded"
                    ]) &&
                    request.resource.data.amount is number &&
                    request.resource.data.amount >= 0 &&
                    request.resource.data.status == "pending" &&
                    request.resource.data.createdAt is timestamp;

      // Admin (or your broad isAdmin) can update status/notes
      allow update: if isAdmin();

      allow delete: if false;
    }

    // Quest claim records (read-only to the user; writes via Functions)
    match /users/{uid}/questClaims/{claimId} {
      allow read: if isAuthed() && request.auth.uid == uid;
      allow write: if false;
    }

    /* =============================
       CASHOUT REQUESTS
    ============================= */
    match /cashout_requests/{id} {

      allow read: if isAuthed() &&
                  (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isAuthed() &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.amount is number &&
                    request.resource.data.amount >= 3 &&
                    request.resource.data.status == "pending" &&
                    request.resource.data.method is string &&
                    request.resource.data.createdAt is timestamp;

      allow update: if isAdmin();
      allow delete: if false;
    }

    /* =============================
       DONATION REQUESTS
    ============================= */
    match /donation_requests/{id} {
      allow read: if isAuthed() &&
                  (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isAuthed() &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.status == "pending" &&
                    request.resource.data.amount > 0 &&
                    request.resource.data.createdAt is timestamp;

      allow update: if isAdmin();
      allow delete: if false;
    }

    /* =============================
       PUBLIC PROFILES
    ============================= */
    match /publicProfiles/{uid} {
      allow read: if isAuthed();

      allow create: if isAuthed() &&
                    request.auth.uid == uid &&
                    request.resource.data.keys().hasOnly(["username","usernameLower","createdAt","updatedAt"]) &&
                    request.resource.data.username is string &&
                    request.resource.data.usernameLower == request.resource.data.username.lower() &&
                    request.resource.data.createdAt is timestamp &&
                    request.resource.data.updatedAt is timestamp;

      allow update: if isAuthed() &&
                    request.auth.uid == uid &&
                    request.resource.data.keys().hasOnly(["username","usernameLower","createdAt","updatedAt"]) &&
                    resource.data.createdAt == request.resource.data.createdAt &&
                    request.resource.data.username is string &&
                    request.resource.data.usernameLower == request.resource.data.username.lower() &&
                    request.resource.data.updatedAt is timestamp;

      allow delete: if false;
    }

    /* =============================
       BREADGAME STATE
    ============================= */
    match /users/{uid}/breadgame/{docId} {
      allow read: if isAuthed() && request.auth.uid == uid;

      allow write: if isAuthed() &&
                    request.auth.uid == uid &&
                    request.resource.data.keys().hasOnly([
                      "crumbs",
                      "clickPowerLevel",
                      "autoClickLevel",
                      "cosmetics"
                    ]);
    }

    /* ============================================================
       GLOBAL ADMIN OVERRIDE (unchanged)
    ============================================================ */
    match /{document=**} {
      allow read, write: if isAdmin();
    }

  }
}
